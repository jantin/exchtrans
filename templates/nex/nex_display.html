{% extends "expBase.html" %}

{% block extrahead %}
<script src="/site_media/scripts/jquery/jquery.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="/site_media/scripts/jquery/jquery.form.js" type="text/javascript" charset="utf-8"></script>
<script src="/site_media/scripts/jquery/jquery.alphanumeric.pack.js" type="text/javascript" ></script>
<script src="/site_media/scripts/jquery/json.js" type="text/javascript" ></script>


<script type="text/javascript" charset="utf-8">
// killPolling is defined as a global because polling can be stopped either by either 
// the poll process itself or a submitted form action
killPolling = false;

// timeout is used for polling
var timeout;


	// Code to run after the page is completely loaded.
	$(document).ready(function() { 
		// Bind widget callbacks
		$("html").bind("widget_timer_event_timeout", function (event) {
			clearTimeout(timeout);
			showScreen("transactionSummary");
		});
		
	    // bind the submit event of all forms on the page. The server response will be
		// delivered to the processFormResponse() function.
	    
		$('form').ajaxForm({success: processFormResponse}); 
		
		// pNum is either 1 or 2 indicating if, within the current pairing, the player is the 1st or 2nd player
		// It's used when building keys to access nex parameters. e.g. exchangeParametersJSON['p' + pNum + 'x']
		pNum = "{{playerNumber}}";

		// Bind the input fields of the offerFormulation screen
		// Updates the "This deal would get you" number on the offerFormulation screen
		$('.offerFormulationInputs').numeric();
		$(".offerFormulationInputs").keyup(function(){
			offerFormulationProcessInput();
		});
		$("#offerFormulationOfferUnit").change(function(){
			offerFormulationProcessInput();
		});
		$("#offerFormulationRequestUnit").change(function(){
			offerFormulationProcessInput();
		});
		
		// Start polling server to check for opponents
		pollServer("/nex/checkForOpponentPollProcess/", 2000);
	});

	// Each screen contains a form that submits the user's input to the server.
	// This function processes the server's response and updates the page accordingly.
	function processFormResponse(responseText){
		// responseText the response returned by the server. It is JSON formatted.
		// Note: parseJSON() is not jQuery, rather it's in json.js from json.org
		responseJSON = responseText.parseJSON();
		
		// exchangeParametersJSON contains the contents of the Nex component object
		exchangeParametersJSON = '{{exchangeParametersJSON}}'.parseJSON();

		// Processor is a reference to the django view that processed the form.
		// The switch excecute certain lines of javascript depending the processor.
		switch( responseJSON['processor'] ){
			case "makeOfferButton":
				// Initialize points preview
				offerFormulationProcessInput();
				break;
		}
		
		if(responseJSON['showScreen']){
			showScreen(responseJSON['showScreen']);
		}
		
		if(responseJSON['continuePolling'] == false){
			killPolling = true;
			clearTimeout(timeout);
		}
		
		// If the server set poll to true, start polling on the given url and interval
		if(responseJSON['poll']){
			killPolling = false;
			pollServer(responseJSON['url'],responseJSON['interval']);
		}
		return;
	}
	
	var pollURL = "";
	var pollInterval = "";

	// This function polls the server
	function pollServer(pollURL, interval){
		clearTimeout(timeout);
		if(!killPolling){
			$.ajax({url: pollURL, dataType: "json", success: function(pollResponseJSON){
					if(pollResponseJSON['continuePolling'] != true){
						clearTimeout(timeout);
						killPolling = true;
						if(pollResponseJSON['showScreen']){
							showScreen(pollResponseJSON['showScreen'])
						}
						if(pollResponseJSON['poll'] == true){
							killPolling = false;
							pollServer(pollResponseJSON['url'], pollResponseJSON['interval']);
						}
					} else {
						timeout = setTimeout("pollServer('" + pollURL + "', " + interval + ")", interval);
					}
				}
			});
		}
		return;
	}
	
	// This function displays only the specified screen. screenName should be the the div ID
	// of the desired screen.
	function showScreen(screenName){
		// Turn off all the screens
		$(".exchangeScreen").css("display", "none");
		// turn on the specified screen
		$("#" + screenName).css("display", "block");
		return;
	}
	
	// Updates the "This deal would get you" number on the offerFormulation screen
	// Called on keyup of the input fields of the offerFormulation screen
	function offerFormulationProcessInput(){
			
			pNum = "{{playerNumber}}";
			
			// Clear the error if present
			$("#offerFormulationOfferError").html("");
			
			// exchangeParametersJSON contains the contents of the Nex component object
			exchangeParametersJSON = '{{exchangeParametersJSON}}'.parseJSON();
			
			// Set up all our working variables
			offer = $("#offerFormulationOffer").val();
			request = $("#offerFormulationRequest").val();
			offerUnit = $("#offerFormulationOfferUnit").val();
			requestUnit = $("#offerFormulationRequestUnit").val();
			availableX = $("#availableX").text();
			availableY = $("#availableY").text();
			xValue = exchangeParametersJSON['p' + pNum + 'xValue'];
			yValue = exchangeParametersJSON['p' + pNum + 'yValue'];
					
			// Calculate the current number of points held by the player this round
			initialPoints = (availableX * xValue) + (availableY * yValue);
			
			// Calculate the loss from offering
			if(offerUnit == "x"){
				// Check that the input value is not beyond the available amount
				if(parseInt(offer) > parseInt(availableX)) {
					offer = availableX;
					$("#offerFormulationOffer").val(offer);
					$("#offerFormulationOfferError").html("You only have " + availableX + " " + offerUnit);
				}
				loss = offer * xValue;
			} else {
				// Check that the input value is not beyond the available amount
				if(parseInt(offer) > parseInt(availableY)) {
					offer = availableY;
					$("#offerFormulationOffer").val(offer);
					$("#offerFormulationOfferError").html("You only have " + availableY + " " + offerUnit);
				}
				loss = offer * yValue;
			}
			
			// Calculate the potential gain from the request
			if(requestUnit == "x"){
				gain = request * xValue;
			} else {
				gain = request * yValue;
			}
			
			// calculate the potential points
			pointsPreview = initialPoints + (gain - loss);		
			
			// Display the preview points
			$("#offerFormulationPoints").html(pointsPreview);
	}

</script>

{% endblock %}

{% block actionArea %}
<div id="checkForOpponent" class="exchangeScreen">
	<br/><br/><br/><br/>
	<h1>You are about to exchange with Player {{opponentIdentity}}</h1>
	<br/><br/><br/><br/>
	<h3>Please wait...</h3>
	<img src="/site_media/images/indicatorMed.gif" width="32" height="32" alt="IndicatorMed">
</div>
<div id="makeOfferButton" style="display:none;" class="exchangeScreen">
	<br/><br/><br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/><br/><br/><br/><br/>
	<form action="/nex/makeOfferButton/" method="post" accept-charset="utf-8">
		<input type="submit" name="makeOfferSubmit" value="Make Offer" class="buttonBig"/>
	</form>
</div>
<div id="offerFormulation" style="display:none;" class="exchangeScreen">
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<form action="/nex/offerFormulation/" method="post" accept-charset="utf-8">
		<p>What will you give?</p>
		<p>
			<input type="text" name="offerFormulationOffer" id="offerFormulationOffer" class="offerFormulationInputs" value="0" size="4" maxlength="4"/>
			<select name="offerFormulationOfferUnit" id="offerFormulationOfferUnit">
				<option>x</option>
				<option>y</option>
			</select>
			<span id="offerFormulationOfferError" class="offerFormulationError"></span>
		</p>
		<p>What do you want in return?</p>
		<p>
			<input type="text" name="offerFormulationRequest" id="offerFormulationRequest" class="offerFormulationInputs" value="0" size="4" maxlength="4"/>
			<select name="offerFormulationRequestUnit" id="offerFormulationRequestUnit">
				<option>y</option>
				<option>x</option>
			</select>
		</p>
		<br/>
		<p>This deal would get you: <b><span id="offerFormulationPoints">0</span></b> points</p>
		<input type="submit" name="offerFormulationOffer" value="Offer" class="buttonBig"/>
	</form>
</div>
<div id="counterOfferFormulation" style="display:none;" class="exchangeScreen">
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<form action="/nex/counterOfferFormulation/" method="post" accept-charset="utf-8">
		<p>Player {{opponentIdentity}} offered you <strong>20 X</strong> for <strong>10 Y</strong>. This deal would get you 50 points.</p>
		<p>Enter your counter offer below.</p>
		<p>What will you give?</p>
		<p>
			<input type="text" name="offerFormulationOffer" id="offerFormulationOffer" class="offerFormulationInputs" value="0" size="4" maxlength="4"/>
			<select name="offerFormulationOfferUnit" id="offerFormulationOfferUnit">
				<option>x</option>
				<option>y</option>
			</select>
			<span id="offerFormulationOfferError" class="offerFormulationError"></span>
		</p>
		<p>What do you want in return?</p>
		<p>
			<input type="text" name="offerFormulationRequest" id="offerFormulationRequest" class="offerFormulationInputs" value="0" size="4" maxlength="4"/>
			<select name="offerFormulationRequestUnit" id="offerFormulationRequestUnit">
				<option>y</option>
				<option>x</option>
			</select>
		</p>
		<br/>
		<p>This deal would get you: <b><span id="offerFormulationPoints">0</span></b> points</p>
		<input type="submit" name="counterOfferFormulationSubmit" value="Cancel" class="buttonBig"/>
		<input type="submit" name="counterOfferFormulationSubmit" value="Counter Offer" class="buttonBig"/>
	</form>
</div>
<div id="waitingScreen" style="display:none;" class="exchangeScreen">
	<br/><br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/>
	<h3>Please wait for player {{opponentIdentity}}</h3>
	<img src="/site_media/images/indicatorMed.gif" width="32" height="32" alt="IndicatorMed">
	<p>
		<form action="/nex/waitingScreen/" method="post" accept-charset="utf-8">
			<input type="submit" name="waitingScreenCancel" value="Cancel" class="buttonBig"/>
		</form>
	</p>
</div>
<div id="confirmCancel" style="display:none;" class="exchangeScreen">
	<br/><br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/><br/>
	<p>Are you sure you want to cancel your offer?</p>
	<p>
		<form action="/nex/confirmCancel/" method="post" accept-charset="utf-8">
			<input type="submit" name="confirmCancelSubmit" value="No" class="buttonBig"/> 
			<input type="submit" name="confirmCancelSubmit" value="Yes" class="buttonBig"/>
		</form>
	</p>
</div>
<div id="incomingOffer" style="display:none;" class="exchangeScreen">
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/><br/><br/>
	<p>Player {{opponentIdentity}} offered you <strong>20 X</strong> for <strong>10 Y</strong></p>
	<p>
		<form action="/nex/incomingOffer/" method="post" accept-charset="utf-8">
			<input type="submit" name="incomingOfferSubmit" value="Accept" class="buttonBig"/> 
			<input type="submit" name="incomingOfferSubmit" value="Counter Offer" class="buttonBig"/>
			<input type="submit" name="incomingOfferSubmit" value="End Round" class="buttonBig"/>
		</form>	
	</p>
</div>
<div id="confirmEndRound" style="display:none;" class="exchangeScreen">
	<br/><br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/><br/>
	<p>Are you sure you want to end this round of exchange?</p>
	<p>
		<form action="/nex/confirmEndRound/" method="post" accept-charset="utf-8">
			<input type="submit" name="confirmEndRoundSubmit" value="No" class="buttonBig"/> 
			<input type="submit" name="confirmEndRoundSubmit" value="Yes" class="buttonBig"/>
		</form>	
	</p>
</div>
<div id="nonBindingConfirmation" style="display:none;" class="exchangeScreen">
		<br/><br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/>
	<p>You accepted player {{opponentIdentity}}'s offer of <strong>12 X</strong> for <strong>10 Y</strong>.<br/>You will get 100 points for this deal.</p>
	<p>Do you want to follow through on your part of the deal<br/> and give 10 Y to player {{opponentIdentity}}?</p>
	<br/>
	<p>
		<form action="/nex/nonBindingConfirmation/" method="post" accept-charset="utf-8">
			<input type="submit" name="nonBindingConfirmationSubmit" value="No" class="buttonBig"/> 
			<input type="submit" name="nonBindingConfirmationSubmit" value="Yes" class="buttonBig"/>
		</form>
	</p>
</div>
<div id="transactionSummary" style="display:none;" class="exchangeScreen">
	<br/><br/>
	<h1>Exchanging with Player {{opponentIdentity}}</h1>
	<br/><br/>
	<p>You accepted player {{opponentIdentity}}'s offer of <strong>12 X</strong> for <strong>10 Y</strong>.</p>
	<p>You received 100 points for this deal.</p>
	<p>
		<form action="/nex/transactionSummary/" method="post" accept-charset="utf-8">
			<input type="submit" name="transactionSummarySubmit" value="Continue" class="buttonBig"/> 
		</form>
	</p>
</div>
<div id="nextRoundCountdown" style="display:none;" class="exchangeScreen">
	<h1>Starting next round shortly</h1>
	<img src="/site_media/images/indicatorMed.gif" width="32" height="32" alt="IndicatorMed">
</div>
{% endblock %}

{% block rightCol %}
	{{widgets}}
{% endblock %}

{% block bottomBar %}

<div id="currentPointsBox">
	<p>Total X</p>
	<div id="availableX" class="largePoints">20</div>
</div>
<div id="cumulativePointsBox">
	<p>Total Y</p>
	<div id="availableY" class="largePoints">5</div>
</div>

{% endblock %}